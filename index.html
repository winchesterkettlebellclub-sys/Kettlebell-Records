<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kettlebell Sport - Results Ranks & Records</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000;
      color: #fff;
      -webkit-font-smoothing:antialiased;
    }
    header { position:relative; overflow:hidden; }
    .banner-wrap { width:100%; display:block; text-align:center; }
    @media (min-width:1024px) { .banner-wrap { max-width:1400px; margin:0 auto; padding:18px 0; } }
    .banner { display:block; width:100%; height:260px; object-fit:cover; object-position:center; background:#000; margin:0 auto; }
    @media (max-width:640px) { .banner { width:100%; max-width:420px; height:140px; object-fit:contain; margin:10px auto; } }
    .sr-only { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
    .container { max-width:1400px; margin:18px auto; padding:0 20px; }
    .controls { background:#333; padding:14px; border-radius:10px; margin-bottom:14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .control-group { min-width:200px; flex:1; display:flex; flex-direction:column; gap:6px; }
    label { font-size:14px; color:#ccc; font-weight:600; }
    select { padding:10px; border:none; border-radius:6px; background:#444; color:#fff; font-size:15px; }
    select:focus { outline:2px solid #1877f2; }
    .info-top { color:#ddd; font-size:14px; margin:10px 0 8px; text-align:center; }

    /* sheet container */
    .sheet-frame { background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.45); min-height:420px; height: calc(100vh - 520px); }
    @media (max-width:780px) { .sheet-frame { height: calc(100vh - 320px); min-height:420px; } }

    /* wrapper where we'll inject the sheet table */
    #tableHolder { width:100%; height:100%; overflow:auto; padding:12px; background:#fff; }

    /* When we import the published table we'll add a small class so we can keep a sticky first column
       without destroying Google-provided inline styles */
    .imported-sheet { width:100%; border-collapse:collapse; min-width:680px; }
    /* keep sticky first column to mimic freeze (only visual helper) */
    .imported-sheet th:first-child,
    .imported-sheet td:first-child {
      position: -webkit-sticky; position: sticky; left: 0; z-index: 3;
      background: rgba(255,255,255,0.98);
      border-right: 1px solid #e6e6e6;
    }
    /* header sticky row */
    .imported-sheet thead th {
      position: sticky; top: 0; z-index:4;
      background: rgba(250,250,250,0.98);
    }

    /* fallback iframe style */
    .iframe-fallback iframe { width:100%; height:100%; border:0; display:block; }

    /* footer social */
    footer.site-footer { max-width:1400px; margin:22px auto 44px; padding:0 20px; display:flex; justify-content:center; gap:14px; align-items:center; }
    .social-btn { display:inline-flex; align-items:center; justify-content:center; width:52px; height:52px; border-radius:50%; text-decoration:none; overflow:hidden; background:#000; box-shadow:0 6px 18px rgba(0,0,0,0.32); transition:transform .12s ease; }
    .social-icon { display:block; width:100%; height:100%; object-fit:contain; background:transparent; padding:8px; }
    .social-btn:hover { transform:translateY(-4px); box-shadow:0 12px 30px rgba(0,0,0,0.42); }
  </style>
</head>
<body>
  <header>
    <div class="banner-wrap">
      <img src="assets/banner.jpg" alt="Kettlebell Sport — Results Ranks & Records" class="banner" />
    </div>
    <div class="sr-only" role="heading" aria-level="1">Kettlebell Sport — Results Ranks & Records</div>
  </header>

  <main class="container" role="main">
    <div class="controls">
      <div class="control-group">
        <label for="category">Select Category</label>
        <select id="category" aria-label="Select competition category">
          <option value="biathlon-male">Biathlon Male</option>
          <option value="biathlon-female">Biathlon Female</option>
          <option value="jerks10-male">Jerks 10' Male</option>
          <option value="jerks10-female">Jerks 10' Female</option>
          <option value="snatch10-male">Snatch 10' Male</option>
          <option value="snatch10-female">Snatch 10' Female</option>
          <option value="lc10-male">LC 10' Male</option>
          <option value="lc10-female">LC 10' Female</option>
          <option value="snatch12-male">Snatch 12' Male</option>
          <option value="snatch12-female">Snatch 12' Female</option>
          <option value="marathon-male">Marathon Male</option>
          <option value="marathon-female">Marathon Female</option>
          <option value="pentathlon-male">Pentathlon Male</option>
          <option value="pentathlon-female">Pentathlon Female</option>
          <option value="ikmf-games">IKMF Games</option>
        </select>
      </div>
    </div>

    <p class="info-top">Tip: Press <strong>Ctrl+F</strong> (Cmd+F on Mac) while focused in the table to search quickly.</p>

    <div id="sheetFrameWrap" class="sheet-frame">
      <!-- we will inject the formatted sheet table into #tableHolder.
           If HTML fetch fails we'll show the iframe fallback in #iframeFallback (inside same container) -->
      <div id="tableHolder" style="display:none;"></div>
      <div id="iframeFallback" class="iframe-fallback" style="display:none; height:100%;"></div>
    </div>
  </main>

  <footer class="site-footer" role="contentinfo" aria-label="Social links">
    <a class="social-btn" href="https://www.facebook.com/groups/kbsportresults" target="_blank" rel="noopener noreferrer" aria-label="Facebook group">
      <img src="assets/fb-icon.webp" alt="Facebook" class="social-icon" onerror="this.style.display='none'">
    </a>
    <a class="social-btn" href="https://www.instagram.com/kettlebell_sport_records" target="_blank" rel="noopener noreferrer" aria-label="Instagram profile">
      <img src="assets/ig-icon.webp" alt="Instagram" class="social-icon" onerror="this.style.display='none'">
    </a>
  </footer>

  <script>
    // mapping of categories to the GID for the published Google Sheet view
    const sheets = {
      'biathlon-male': '93885002',
      'biathlon-female': '152053352',
      'jerks10-male': '726455571',
      'jerks10-female': '635122239',
      'snatch10-male': '2146152642',
      'snatch10-female': '960654845',
      'lc10-male': '2094974882',
      'lc10-female': '410226466',
      'snatch12-male': '321570812',
      'snatch12-female': '177574292',
      'marathon-male': '1504962327',
      'marathon-female': '867269512',
      'pentathlon-male': '1333859027',
      'pentathlon-female': '225439885',
      'ikmf-games': '893865195'
    };

    // base published HTML endpoint (we will fetch the HTML view)
    const basePubHtml = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3IpckvYxUsOYfT_smcIWSNTK4OWHbGtwSUGoWXhWnLntwPuIt81PAdGLvnLdYiasjgtMhd0Rd-Pzm/pubhtml';

    const categoryEl = document.getElementById('category');
    const tableHolder = document.getElementById('tableHolder');
    const iframeFallback = document.getElementById('iframeFallback');

    async function loadSheetAsHtml(gid) {
      // hide both until success
      tableHolder.style.display = 'none';
      iframeFallback.style.display = 'none';

      const htmlUrl = `${basePubHtml}?gid=${encodeURIComponent(gid)}&single=true&widget=true&headers=false`;

      try {
        const res = await fetch(htmlUrl);
        if (!res.ok) throw new Error('HTML fetch failed: ' + res.status);
        const htmlText = await res.text();

        // Parse and extract the table
        const doc = new DOMParser().parseFromString(htmlText, 'text/html');

        // The published HTML typically contains a table element with the sheet contents.
        // Find the first table. If there are multiple, choose the table with class 'waffle' or the first <table>.
        let table = doc.querySelector('table.waffle') || doc.querySelector('table');

        if (!table) throw new Error('No table found in published HTML');

        // Remove a leading title row that Google sometimes includes by detecting a single-cell first row
        // If first row has only one cell and next row has multiple, drop the first row.
        // We'll operate on a clone so we don't mutate the original fetched doc.
        const tableClone = table.cloneNode(true);

        // Make sure headers are in thead/tbody; if not, try to normalize
        // Remove any caption or title elements that are not part of the actual grid:
        const caption = tableClone.querySelector('caption');
        if (caption) caption.remove();

        // detect and remove leading title row(s)
        const allRows = Array.from(tableClone.querySelectorAll('tr'));
        if (allRows.length >= 2) {
          const firstCells = allRows[0].children;
          const secondCells = allRows[1] ? allRows[1].children : null;
          const firstNonEmpty = Array.from(firstCells).filter(td => td.textContent.trim() !== '').length;
          const secondNonEmpty = secondCells ? Array.from(secondCells).filter(td => td.textContent.trim() !== '').length : 0;
          if (firstCells.length === 1 && secondCells && secondCells.length > 1 && firstNonEmpty >= 1 && secondNonEmpty > 1) {
            // remove the first row
            allRows[0].remove();
          }
        }

        // Add a CSS class so our page styling can apply (sticky first column)
        tableClone.classList.add('imported-sheet');

        // Inject the cleaned table into the tableHolder
        tableHolder.innerHTML = '';
        // Keep the table's inline styles and cells (this preserves conditional-format colours)
        tableHolder.appendChild(tableClone);

        // show the table
        tableHolder.style.display = 'block';
        iframeFallback.style.display = 'none';

        // optional: allow keyboard focus for Ctrl+F (makes browser find focus inside table area)
        tableClone.tabIndex = -1;
        tableClone.focus && tableClone.focus();

      } catch (err) {
        console.warn('HTML rendering failed, falling back to iframe view:', err);
        showIframeFallback(gid);
      }
    }

    function showIframeFallback(gid) {
      iframeFallback.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = `${basePubHtml}?gid=${encodeURIComponent(gid)}&single=true&widget=true&headers=false`;
      iframe.title = 'Kettlebell results (iframe fallback)';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframeFallback.appendChild(iframe);
      iframeFallback.style.display = 'block';
    }

    // initial load + category change
    function init() {
      const defaultGid = sheets[categoryEl.value];
      loadSheetAsHtml(defaultGid);
      categoryEl.addEventListener('change', () => {
        const gid = sheets[categoryEl.value];
        loadSheetAsHtml(gid);
      });
    }

    init();
  </script>
</body>
</html>