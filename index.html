<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kettlebell Sport - Results Ranks & Records</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000;
      color: #fff;
      -webkit-font-smoothing:antialiased;
    }

    /* Banner + layout */
    header { position:relative; overflow:hidden; }
    .banner-wrap { width:100%; display:block; text-align:center; }
    @media (min-width:1024px) {
      .banner-wrap { max-width:1400px; margin:0 auto; padding:10px 0; } /* small desktop vertical padding */
    }
    .banner {
      display:block; width:100%; height:260px; object-fit:cover; object-position:center; background:#000; margin:0 auto;
    }
    @media (max-width:640px) {
      .banner { width:100%; max-width:420px; height:140px; object-fit:contain; margin:6px auto; } /* reduced padding on phone */
      .banner-wrap { padding:6px 0; } /* reduce banner top/bottom padding on phone */
    }

    .sr-only { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

    .container { max-width:1400px; margin:18px auto; padding:0 20px; }

    /* controls */
    .controls { background:#333; padding:12px; border-radius:10px; margin-bottom:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .control-group { min-width:200px; flex:1; display:flex; flex-direction:column; gap:6px; }
    label { font-size:14px; color:#ccc; font-weight:600; }
    select { padding:10px; border:none; border-radius:6px; background:#444; color:#fff; font-size:15px; }
    select:focus { outline:2px solid #1877f2; }
    .info-top { color:#ddd; font-size:14px; margin:10px 0 8px; text-align:center; }

    /* sheet container */
    .sheet-frame { background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.45); min-height:420px; height: calc(100vh - 520px); }
    @media (max-width:780px) { .sheet-frame { height: calc(100vh - 320px); min-height:360px; } }

    /* holder for imported HTML table */
    #tableHolder { width:100%; height:100%; overflow:auto; padding:8px; background:#fff; }

    /* styling for the imported table (keeps sheet inline styles, but we add a few helpers) */
    .imported-sheet { width:100%; border-collapse:collapse; min-width:680px; }
    .imported-sheet th, .imported-sheet td { padding:6px 10px; vertical-align:middle; }
    /* sticky header row (preserve sheet header styling; increase z-index) */
    .imported-sheet thead th { position: sticky; top: 0; z-index: 5; }
    /* make first column sticky to mimic freeze - do NOT override background so conditional formatting color remains */
    .imported-sheet th:first-child,
    .imported-sheet td:first-child {
      position: -webkit-sticky; position: sticky;
      left: 0;
      z-index: 4; /* less than header corner */
      box-shadow: 2px 0 6px rgba(0,0,0,0.06);
    }
    /* corner cell (header + first column) should be on top */
    .imported-sheet thead th:first-child { z-index: 7; }

    /* fallback iframe */
    .iframe-fallback iframe { width:100%; height:100%; border:0; display:block; }

    /* footer social */
    footer.site-footer { max-width:1400px; margin:18px auto 36px; padding:0 20px; display:flex; justify-content:center; gap:14px; align-items:center; }
    .social-btn { display:inline-flex; align-items:center; justify-content:center; width:52px; height:52px; border-radius:50%; text-decoration:none; overflow:hidden; background:#000; box-shadow:0 6px 18px rgba(0,0,0,0.32); transition:transform .12s ease; }
    .social-icon { display:block; width:100%; height:100%; object-fit:contain; background:transparent; padding:8px; }
    .social-btn:hover { transform:translateY(-4px); box-shadow:0 12px 30px rgba(0,0,0,0.42); }

  </style>
</head>
<body>
  <header>
    <div class="banner-wrap">
      <img src="assets/banner.jpg" alt="Kettlebell Sport — Results Ranks & Records" class="banner" />
    </div>
    <div class="sr-only" role="heading" aria-level="1">Kettlebell Sport — Results Ranks & Records</div>
  </header>

  <main class="container" role="main">
    <div class="controls">
      <div class="control-group">
        <label for="category">Select Category</label>
        <select id="category" aria-label="Select competition category">
          <option value="biathlon-male">Biathlon Male</option>
          <option value="biathlon-female">Biathlon Female</option>
          <option value="jerks10-male">Jerks 10' Male</option>
          <option value="jerks10-female">Jerks 10' Female</option>
          <option value="snatch10-male">Snatch 10' Male</option>
          <option value="snatch10-female">Snatch 10' Female</option>
          <option value="lc10-male">LC 10' Male</option>
          <option value="lc10-female">LC 10' Female</option>
          <option value="snatch12-male">Snatch 12' Male</option>
          <option value="snatch12-female">Snatch 12' Female</option>
          <option value="marathon-male">Marathon Male</option>
          <option value="marathon-female">Marathon Female</option>
          <option value="pentathlon-male">Pentathlon Male</option>
          <option value="pentathlon-female">Pentathlon Female</option>
          <option value="ikmf-games">IKMF Games</option>
        </select>
      </div>
    </div>

    <p class="info-top">Tip: Press <strong>Ctrl+F</strong> (Cmd+F on Mac) while focused in the table to search quickly.</p>

    <div id="sheetFrameWrap" class="sheet-frame" aria-live="polite">
      <div id="tableHolder" style="display:none;"></div>
      <div id="iframeFallback" class="iframe-fallback" style="display:none; height:100%;"></div>
    </div>
  </main>

  <footer class="site-footer" role="contentinfo" aria-label="Social links">
    <a class="social-btn" href="https://www.facebook.com/groups/kbsportresults" target="_blank" rel="noopener noreferrer" aria-label="Facebook group">
      <img src="assets/fb-icon.webp" alt="Facebook" class="social-icon" onerror="this.style.display='none'">
    </a>
    <a class="social-btn" href="https://www.instagram.com/kettlebell_sport_records" target="_blank" rel="noopener noreferrer" aria-label="Instagram profile">
      <img src="assets/ig-icon.webp" alt="Instagram" class="social-icon" onerror="this.style.display='none'">
    </a>
  </footer>

  <script>
    const sheets = {
      'biathlon-male': '93885002',
      'biathlon-female': '152053352',
      'jerks10-male': '726455571',
      'jerks10-female': '635122239',
      'snatch10-male': '2146152642',
      'snatch10-female': '960654845',
      'lc10-male': '2094974882',
      'lc10-female': '410226466',
      'snatch12-male': '321570812',
      'snatch12-female': '177574292',
      'marathon-male': '1504962327',
      'marathon-female': '867269512',
      'pentathlon-male': '1333859027',
      'pentathlon-female': '225439885',
      'ikmf-games': '893865195'
    };

    const basePubHtml = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3IpckvYxUsOYfT_smcIWSNTK4OWHbGtwSUGoWXhWnLntwPuIt81PAdGLvnLdYiasjgtMhd0Rd-Pzm/pubhtml';

    const categoryEl = document.getElementById('category');
    const tableHolder = document.getElementById('tableHolder');
    const iframeFallback = document.getElementById('iframeFallback');

    // Helper: compute colSpan sum for a <tr>
    function rowColSpanCount(tr) {
      let sum = 0;
      Array.from(tr.children).forEach(cell => {
        const colspan = parseInt(cell.getAttribute('colspan') || '1', 10);
        sum += isNaN(colspan) ? 1 : colspan;
      });
      return sum;
    }

    async function loadSheetHtml(gid) {
      tableHolder.style.display = 'none';
      iframeFallback.style.display = 'none';
      const url = `${basePubHtml}?gid=${encodeURIComponent(gid)}&single=true&widget=true&headers=false`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('fetch failed: ' + res.status);
        const text = await res.text();
        const doc = new DOMParser().parseFromString(text, 'text/html');

        // attempt to find the main sheet table:
        // prefer table.waffle (Google's table class), else first big table
        let table = doc.querySelector('table.waffle') || Array.from(doc.querySelectorAll('table')).find(t => t.rows.length > 1);

        if (!table) throw new Error('no table found in published HTML');

        // clone so we can mutate
        const tableClone = table.cloneNode(true);

        // remove caption if present
        const caption = tableClone.querySelector('caption');
        if (caption) caption.remove();

        // remove leading empty rows
        const rows = Array.from(tableClone.querySelectorAll('tr'));
        // compute max columns across rows (sum of colspans)
        const colCounts = rows.map(r => rowColSpanCount(r));
        const maxCols = Math.max(...colCounts, 1);

        // Drop initial rows that are empty (all cells empty)
        let start = 0;
        while (start < rows.length) {
          const cells = Array.from(rows[start].children);
          const nonEmpty = cells.some(td => td.textContent.trim() !== '');
          if (nonEmpty) break;
          rows[start].remove();
          start++;
        }

        // Recompute after removing empties
        const rows2 = Array.from(tableClone.querySelectorAll('tr'));
        // If the very first remaining row spans nearly all columns and next row has multiple cells,
        // treat it as a sheet title and remove it.
        if (rows2.length >= 2) {
          const first = rows2[0];
          const firstCols = rowColSpanCount(first);
          const second = rows2[1];
          const secondCols = rowColSpanCount(second);
          const firstNonEmpty = Array.from(first.children).filter(c => c.textContent.trim() !== '').length;
          const secondNonEmpty = Array.from(second.children).filter(c => c.textContent.trim() !== '').length;

          // heuristics to detect a title row:
          // - first row spans >= 75% of maxCols OR first row has 1 cell with text and next row has >1 non-empty cells
          if (firstCols >= Math.max(1, Math.round(maxCols * 0.75)) || (firstNonEmpty === 1 && secondNonEmpty > 1)) {
            first.remove();
          }
        }

        // Ensure a THEAD exists: if first row contains header-like cells, move it into THEAD
        const finalRows = Array.from(tableClone.querySelectorAll('tr'));
        if (finalRows.length > 0) {
          const firstRow = finalRows[0];
          // if table has no THEAD, create one and move firstRow into it
          if (!tableClone.querySelector('thead')) {
            const thead = document.createElement('thead');
            thead.appendChild(firstRow.cloneNode(true));
            tableClone.insertBefore(thead, tableClone.firstChild);
            // remove the original firstRow (it will be duplicated)
            firstRow.remove();
          }
        }

        // Add helper class
        tableClone.classList.add('imported-sheet');

        // Inject into page
        tableHolder.innerHTML = '';
        // Keep inline styles, but wrap in a scroll container
        tableHolder.appendChild(tableClone);
        tableHolder.style.display = 'block';
        iframeFallback.style.display = 'none';

        // small accessibility help
        tableClone.tabIndex = -1;
        tableClone.focus && tableClone.focus();
      } catch (err) {
        console.warn('HTML import failed, falling back to iframe', err);
        showIframeFallback(gid);
      }
    }

    function showIframeFallback(gid) {
      iframeFallback.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = `${basePubHtml}?gid=${encodeURIComponent(gid)}&single=true&widget=true&headers=false`;
      iframe.title = 'Kettlebell results (iframe fallback)';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframeFallback.appendChild(iframe);
      iframeFallback.style.display = 'block';
    }

    // init
    function init() {
      const defaultGid = sheets[categoryEl.value];
      loadSheetHtml(defaultGid);
      categoryEl.addEventListener('change', () => {
        const gid = sheets[categoryEl.value];
        loadSheetHtml(gid);
      });
    }

    init();
  </script>
</body>
</html>