<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kettlebell Sport - Results Ranks & Records</title>

  <!-- Cookie consent CSS (please upload cookie-consent.css to your repo) -->
  <link rel="stylesheet" href="cookie-consent.css">

  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body { height:100%; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000;     /* black background */
      color: #fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Header / Banner */
    header { position:relative; overflow:hidden; }
    .banner-wrap { width:100%; display:block; text-align:center; }
    @media (min-width:1024px) { .banner-wrap { max-width:1400px; margin:0 auto; padding:10px 0; } }
    .banner {
      display:block; width:100%; height:260px; object-fit:cover; object-position:center; background-color:#000; margin:0 auto;
    }
    @media (max-width:640px) {
      .banner { width:100%; max-width:420px; height:140px; object-fit:contain; margin:6px auto; }
      .banner-wrap { padding:6px 0; }
    }

    .sr-only { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

    /* Page link below banner (Submit button style) */
    .page-nav { text-align:center; margin: 10px 0 6px; }
    .page-nav a {
      display:inline-block; padding:8px 14px; border-radius:8px; background:#1877f2; color:#fff; text-decoration:none; font-weight:600;
      box-shadow:0 6px 18px rgba(0,0,0,0.35); transition:transform .12s ease;
    }
    .page-nav a:hover { transform:translateY(-3px); }

    /* Page container */
    .container { max-width:1400px; margin:14px auto 28px; padding:0 20px; min-height:0; }

    /* Controls */
    .controls { background:#333; padding:12px; border-radius:10px; margin-bottom:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .control-group { min-width:200px; flex:1; display:flex; flex-direction:column; gap:6px; }
    label { font-size:14px; color:#ccc; font-weight:600; }
    select { padding:10px; border:none; border-radius:6px; background:#444; color:#fff; font-size:15px; }
    select:focus { outline:2px solid #1877f2; }

    .info-top { color:#ddd; font-size:14px; margin:10px 0 8px; text-align:center; }

    /* Sheet container */
    .sheet-frame { background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.45); min-height:420px; height: calc(100vh - 520px); }
    @media (max-width:780px) { .sheet-frame { height: calc(100vh - 320px); min-height:360px; } }

    /* holder for imported HTML table */
    #tableHolder { width:100%; height:100%; overflow:auto; padding:8px; background:#fff; color:#111; }
    .imported-sheet { width:100%; border-collapse:collapse; min-width:680px; }
    .imported-sheet th, .imported-sheet td { padding:6px 10px; vertical-align:middle; }
    .imported-sheet thead th { position: sticky; top: 0; z-index: 6; }
    .imported-sheet th:first-child, .imported-sheet td:first-child {
      position: -webkit-sticky; position: sticky; left: 0; z-index: 5; box-shadow: 2px 0 6px rgba(0,0,0,0.06);
    }
    .imported-sheet thead th:first-child { z-index: 8; }

    .iframe-fallback iframe { width:100%; height:100%; border:0; display:block; }

    /* Submit form page (embedded form view) */
    .submit-page { display:none; max-width:1400px; margin: 8px auto 28px; padding: 0 20px; }
    .submit-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .submit-title { font-size:18px; color:#fff; font-weight:700; }
    .back-link { display:inline-block; padding:8px 12px; border-radius:8px; background:#333; color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,0.04); }
    .form-frame { background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.45); padding:0; }
    .form-frame iframe { width:100%; height: calc(100vh - 220px); min-height:600px; border:0; }
    @media (max-width:640px) { .form-frame iframe { height: calc(100vh - 160px); min-height:500px; } }

    /* Footer social and links */
    footer.site-footer { max-width:1400px; margin:18px auto 30px; padding:0 20px; display:flex; justify-content:space-between; gap:14px; align-items:center; flex-wrap:wrap; }
    .socials { display:flex; gap:14px; align-items:center; }
    .footer-links { display:flex; gap:12px; align-items:center; }
    /* Footer links now styled to match submit button (same blue) */
    .footer-links a {
      color:#fff;
      text-decoration:none;
      background:#1877f2;
      padding:8px 12px;
      border-radius:8px;
      font-weight:600;
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
      transition:transform .12s ease;
    }
    .footer-links a:hover { transform:translateY(-3px); }
    .social-btn { display:inline-flex; align-items:center; justify-content:center; width:52px; height:52px; border-radius:50%; text-decoration:none; overflow:hidden; background:#000; box-shadow:0 6px 18px rgba(0,0,0,0.32); transition:transform .12s ease; }
    .social-icon { display:block; width:100%; height:100%; object-fit:contain; background:transparent; padding:8px; }
    .social-btn:hover { transform:translateY(-4px); box-shadow:0 12px 30px rgba(0,0,0,0.42); }

    /* small responsive tweaks */
    @media (max-width:420px) {
      .controls { padding:10px; }
      .container { margin:10px auto 22px; padding:0 12px; }
      .page-nav a { padding:8px 10px; }
      footer.site-footer { justify-content:center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="banner-wrap">
      <img src="assets/banner.jpg" alt="Kettlebell Sport — Results Ranks & Records" class="banner" />
    </div>

    <!-- link to the embedded submission page (just below the banner) -->
    <div class="page-nav" aria-hidden="false">
      <a href="#submit" id="submitNav">Submit a result</a>
    </div>

    <div class="sr-only" role="heading" aria-level="1">Kettlebell Sport — Results Ranks & Records</div>
  </header>

  <!-- MAIN view (sheets) -->
  <main id="mainView" class="container" role="main">
    <div class="controls" aria-hidden="false">
      <div class="control-group">
        <label for="category">Select Lift / Discipline</label>
        <select id="category" aria-label="Select Lift / Discipline">
          <option value="biathlon-male">Biathlon Male</option>
          <option value="biathlon-female">Biathlon Female</option>
          <option value="jerks10-male">Jerks 10' Male</option>
          <option value="jerks10-female">Jerks 10' Female</option>
          <option value="snatch10-male">Snatch 10' Male</option>
          <option value="snatch10-female">Snatch 10' Female</option>
          <option value="lc10-male">LC 10' Male</option>
          <option value="lc10-female">LC 10' Female</option>
          <option value="snatch12-male">Snatch 12' Male</option>
          <option value="snatch12-female">Snatch 12' Female</option>
          <option value="marathon-male">Marathon Male</option>
          <option value="marathon-female">Marathon Female</option>
          <option value="pentathlon-male">Pentathlon Male</option>
          <option value="pentathlon-female">Pentathlon Female</option>
          <option value="ikmf-games">IKMF Games</option>
        </select>
      </div>
    </div>

    <p class="info-top">Tip: Press <strong>Ctrl+F</strong> (Cmd+F on Mac) while focused in the table to search quickly.</p>

    <div id="sheetFrameWrap" class="sheet-frame" aria-live="polite">
      <div id="tableHolder" style="display:none;"></div>
      <div id="iframeFallback" class="iframe-fallback" style="display:none; height:100%;"></div>
    </div>
  </main>

  <!-- SUBMIT view (hidden by default) -->
  <section id="submitView" class="submit-page" aria-hidden="true">
    <div class="submit-header">
      <div class="submit-title">Submit a result</div>
      <div>
        <a href="#" class="back-link" id="backToMain">← Back to results</a>
      </div>
    </div>

    <div class="form-frame" aria-live="polite">
      <!-- Embedded Google Form (responsive). If you prefer a separate contact page we also link to contact.html -->
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeRfJFJeB2yPOIOzNqLDZ0vvEBaWPx0mIiYxHtg_reVrGLiVg/viewform?embedded=true"
              title="Submit a result form"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
        Loading…
      </iframe>
    </div>
  </section>

  <footer class="site-footer" role="contentinfo" aria-label="Footer">
    <div class="socials">
      <a class="social-btn" href="https://www.facebook.com/groups/kbsportresults" target="_blank" rel="noopener noreferrer" aria-label="Facebook group">
        <img src="assets/fb-icon.webp" alt="Facebook" class="social-icon" onerror="this.style.display='none'">
      </a>

      <a class="social-btn" href="https://www.instagram.com/kettlebell_sport_records" target="_blank" rel="noopener noreferrer" aria-label="Instagram profile">
        <img src="assets/ig-icon.webp" alt="Instagram" class="social-icon" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="footer-links">
      <!-- Use relative paths to files in the repository root -->
      <a href="about.html">About</a>
      <a href="privacy.html">Privacy</a>
      <a href="contact.html">Contact</a>
    </div>
  </footer>

  <!-- Cookie consent script (please upload cookie-consent.js to your repo) -->
  <script src="cookie-consent.js" defer></script>

  <script>
    /**
     * Configuration
     */
    const sheets = {
      'biathlon-male': '93885002',
      'biathlon-female': '152053352',
      'jerks10-male': '726455571',
      'jerks10-female': '635122239',
      'snatch10-male': '2146152642',
      'snatch10-female': '960654845',
      'lc10-male': '2094974882',
      'lc10-female': '410226466',
      'snatch12-male': '321570812',
      'snatch12-female': '177574292',
      'marathon-male': '1504962327',
      'marathon-female': '867269512',
      'pentathlon-male': '1333859027',
      'pentathlon-female': '225439885',
      'ikmf-games': '893865195'
    };

    const basePubHtml = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3IpckvYxUsOYfT_smcIWSNTK4OWHbGtwSUGoWXhWnLntwPuIt81PAdGLvnLdYiasjgtMhd0Rd-Pzm/pubhtml';

    // DOM refs
    const categoryEl = document.getElementById('category');
    const tableHolder = document.getElementById('tableHolder');
    const iframeFallback = document.getElementById('iframeFallback');
    const mainView = document.getElementById('mainView');
    const submitView = document.getElementById('submitView');
    const submitNav = document.getElementById('submitNav');
    const backToMain = document.getElementById('backToMain');

    // Helper to compute colspan count
    function rowColSpanCount(tr) {
      let sum = 0;
      Array.from(tr.children).forEach(cell => {
        const colspan = parseInt(cell.getAttribute('colspan') || '1', 10);
        sum += isNaN(colspan) ? 1 : colspan;
      });
      return sum;
    }

    // Fetch published HTML, extract table, remove title/empty rows, inject preserving inline styles (keeps formatting)
    async function loadSheetHtml(gid) {
      tableHolder.style.display = 'none';
      iframeFallback.style.display = 'none';
      const url = `${basePubHtml}?gid=${encodeURIComponent(gid)}&single=true&widget=true&headers=false&cb=${Date.now()}`;
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('fetch failed: ' + res.status);
        const text = await res.text();
        const doc = new DOMParser().parseFromString(text, 'text/html');

        let table = doc.querySelector('table.waffle') || Array.from(doc.querySelectorAll('table')).find(t => t.rows.length > 1);
        if (!table) throw new Error('No table found in published HTML');

        const tableClone = table.cloneNode(true);
        const caption = tableClone.querySelector('caption'); if (caption) caption.remove();

        // Remove leading empty rows
        let rows = Array.from(tableClone.querySelectorAll('tr'));
        while (rows.length && rows[0].children.length && Array.from(rows[0].children).every(td => td.textContent.trim() === '')) {
          rows[0].remove();
          rows = Array.from(tableClone.querySelectorAll('tr'));
        }

        // Detect & remove title row heuristically
        const remaining = Array.from(tableClone.querySelectorAll('tr'));
        if (remaining.length >= 2) {
          const first = remaining[0];
          const second = remaining[1];
          const firstCols = rowColSpanCount(first);
          const allRows = Array.from(tableClone.querySelectorAll('tr'));
          const maxCols = Math.max(...allRows.map(r => rowColSpanCount(r)), 1);
          const firstNonEmpty = Array.from(first.children).filter(c => c.textContent.trim() !== '').length;
          const secondNonEmpty = Array.from(second.children).filter(c => c.textContent.trim() !== '').length;

          if (firstCols >= Math.max(1, Math.round(maxCols * 0.75)) || (firstNonEmpty === 1 && secondNonEmpty > 1)) {
            first.remove();
          }
        }

        // Ensure THEAD exists: move first row into THEAD if missing
        const finalRows = Array.from(tableClone.querySelectorAll('tr'));
        if (finalRows.length > 0 && !tableClone.querySelector('thead')) {
          const firstRow = finalRows[0];
          const thead = document.createElement('thead');
          thead.appendChild(firstRow.cloneNode(true));
          tableClone.insertBefore(thead, tableClone.firstChild);
          firstRow.remove();
        }

        tableClone.classList.add('imported-sheet');
        tableHolder.innerHTML = '';
        tableHolder.appendChild(tableClone);
        tableHolder.style.display = 'block';
        iframeFallback.style.display = 'none';

        tableClone.tabIndex = -1;
        tableClone.focus && tableClone.focus();

        return text;
      } catch (err) {
        console.warn('HTML import failed, falling back to iframe', err);
        showIframeFallback(gid);
        return null;
      }
    }

    function showIframeFallback(gid) {
      iframeFallback.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = `${basePubHtml}?gid=${encodeURIComponent(gid)}&single=true&widget=true&headers=false`;
      iframe.title = 'Kettlebell results (iframe fallback)';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframeFallback.appendChild(iframe);
      iframeFallback.style.display = 'block';
    }

    /* Polling (automatic every 2 minutes) */
    const POLL_INTERVAL_MS = 120000; // 2 minutes
    let pollTimer = null;
    let lastSnapshot = null;

    async function fetchPublishedHtmlText(gid) {
      const url = `${basePubHtml}?gid=${encodeURIComponent(gid)}&single=true&widget=true&headers=false&cb=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Fetch failed: ' + res.status);
      return res.text();
    }

    async function pollCheck(gid) {
      try {
        const html = await fetchPublishedHtmlText(gid);
        const snapshot = html ? html.trim() : '';
        if (lastSnapshot === null) {
          lastSnapshot = snapshot;
          await loadSheetHtml(gid);
          return;
        }
        if (snapshot !== lastSnapshot) {
          lastSnapshot = snapshot;
          await loadSheetHtml(gid);
        }
      } catch (err) {
        console.warn('Polling check failed:', err);
      }
    }

    function startPolling() {
      if (pollTimer) return;
      const gidNow = sheets[categoryEl.value];
      pollCheck(gidNow).catch(() => {});
      pollTimer = setInterval(() => {
        const gidCurrent = sheets[categoryEl.value];
        pollCheck(gidCurrent).catch(() => {});
      }, POLL_INTERVAL_MS);
    }

    function stopPolling() {
      if (!pollTimer) return;
      clearInterval(pollTimer);
      pollTimer = null;
    }

    /* Simple routing: show main or submit view */
    function showView(view) {
      if (view === 'submit') {
        mainView.style.display = 'none';
        submitView.style.display = 'block';
        submitView.setAttribute('aria-hidden', 'false');
        mainView.setAttribute('aria-hidden', 'true');
        stopPolling();
        history.pushState({ view: 'submit' }, '', '#submit');
      } else {
        submitView.style.display = 'none';
        mainView.style.display = 'block';
        submitView.setAttribute('aria-hidden', 'true');
        mainView.setAttribute('aria-hidden', 'false');
        lastSnapshot = null;
        const gid = sheets[categoryEl.value];
        loadSheetHtml(gid).catch(() => {});
        startPolling();
        history.pushState({ view: 'main' }, '', window.location.pathname);
      }
    }

    // handle clicks on nav elements
    submitNav.addEventListener('click', (e) => {
      e.preventDefault();
      showView('submit');
    });
    backToMain.addEventListener('click', (e) => {
      e.preventDefault();
      showView('main');
    });

    // handle browser back/forward navigation
    window.addEventListener('popstate', (e) => {
      const state = e.state;
      if (state && state.view === 'submit') {
        showView('submit');
      } else {
        showView('main');
      }
    });

    // when category changes, immediately load that sheet and reset snapshot
    categoryEl.addEventListener('change', () => {
      lastSnapshot = null;
      const gid = sheets[categoryEl.value];
      loadSheetHtml(gid).catch(() => {});
    });

    // init: load default sheet and start polling; if page hash is #submit show submit page
    (function init() {
      const initialGid = sheets[categoryEl.value];
      const hash = window.location.hash || '';
      if (hash.toLowerCase() === '#submit') {
        showView('submit');
      } else {
        showView('main');
      }
      if (mainView.style.display !== 'none') {
        loadSheetHtml(initialGid).then(text => {
          lastSnapshot = text ? text.trim() : null;
        }).catch(() => { lastSnapshot = null; });
        startPolling();
      }
    })();
  </script>
</body>
</html>